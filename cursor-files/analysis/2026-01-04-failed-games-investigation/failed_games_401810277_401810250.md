# Investigation: Failed Games 401810277 and 401810250

**Date**: 2026-01-04 23:23:35  
**Issue**: These two games are still failing after applying time alignment fix to materialized view  
**Games**: `401810277`, `401810250`

---

## Investigation Plan

### Step 1: Basic Game Metadata
Check if games exist and have basic info.

### Step 2: ESPN Data Coverage
Check ESPN probability snapshots.

### Step 3: Kalshi Market Coverage
Check if games have Kalshi markets.

### Step 4: Kalshi Candlestick Coverage
Check candlestick data availability.

### Step 5: games_with_kalshi Filter Status
Check if games pass the filter.

### Step 6: Materialized View Coverage
Check what's in the canonical dataset.

### Step 7: Time Alignment Analysis
Check game start, ESPN timestamps, Kalshi timestamps, and alignment.

### Step 8: Raw vs Aligned Timestamp Comparison
Verify alignment is working correctly.

---

## SQL Queries to Run

### Step 1: Game Metadata
```sql
SELECT 
    event_id,
    event_date,
    home_team_abbrev,
    away_team_abbrev,
    home_score,
    away_score,
    status_completed
FROM espn.scoreboard_games
WHERE event_id IN ('401810277', '401810250')
ORDER BY event_id;
```

### Step 2: ESPN Probability Coverage
```sql
SELECT 
    game_id,
    COUNT(*) as prob_count,
    MIN(last_modified_utc) as first_prob,
    MAX(last_modified_utc) as last_prob,
    COUNT(DISTINCT sequence_number) as unique_sequences
FROM espn.probabilities_raw_items
WHERE game_id IN ('401810277', '401810250')
GROUP BY game_id
ORDER BY game_id;
```

### Step 3: Kalshi Market Coverage
```sql
SELECT 
    sg.event_id,
    COUNT(DISTINCT kmw.ticker) as market_count,
    COUNT(DISTINCT CASE WHEN kmw.kalshi_team_side = 'home' THEN kmw.ticker END) as home_markets,
    COUNT(DISTINCT CASE WHEN kmw.kalshi_team_side = 'away' THEN kmw.ticker END) as away_markets
FROM espn.scoreboard_games sg
LEFT JOIN kalshi.markets_with_games kmw ON sg.event_id = kmw.espn_event_id
WHERE sg.event_id IN ('401810277', '401810250')
GROUP BY sg.event_id
ORDER BY sg.event_id;
```

### Step 4: Kalshi Candlestick Coverage
```sql
SELECT 
    kmw.espn_event_id as game_id,
    kmw.ticker,
    kmw.kalshi_team_side,
    COUNT(DISTINCT kc.period_ts) as candlestick_count,
    MIN(kc.period_ts) as first_candle,
    MAX(kc.period_ts) as last_candle,
    COUNT(DISTINCT CASE WHEN kc.yes_bid_close IS NOT NULL AND kc.yes_ask_close IS NOT NULL THEN kc.period_ts END) as candles_with_bid_ask
FROM kalshi.markets_with_games kmw
LEFT JOIN kalshi.candlesticks kc ON kmw.ticker = kc.ticker
WHERE kmw.espn_event_id IN ('401810277', '401810250')
GROUP BY kmw.espn_event_id, kmw.ticker, kmw.kalshi_team_side
ORDER BY kmw.espn_event_id, kmw.ticker;
```

### Step 5: games_with_kalshi Filter Status
```sql
SELECT
    sg.event_id,
    CASE
        WHEN EXISTS (
            SELECT 1
            FROM kalshi.markets_with_games mwg
            WHERE mwg.espn_event_id = sg.event_id
              AND EXISTS (
                SELECT 1
                FROM kalshi.candlesticks c
                WHERE c.ticker = mwg.ticker
                  AND c.yes_bid_close IS NOT NULL
                  AND c.yes_ask_close IS NOT NULL
              )
        ) THEN 'HAS_KALSHI'
        ELSE 'NO_KALSHI'
    END as kalshi_status
FROM espn.scoreboard_games sg
WHERE sg.event_id IN ('401810277', '401810250')
ORDER BY sg.event_id;
```

### Step 6: Materialized View Coverage
```sql
SELECT 
    game_id,
    COUNT(*) as snapshot_count,
    COUNT(DISTINCT sequence_number) as unique_sequences,
    COUNT(CASE WHEN kalshi_home_mid_price IS NOT NULL THEN 1 END) as snapshots_with_kalshi,
    COUNT(CASE WHEN espn_home_prob IS NOT NULL THEN 1 END) as snapshots_with_espn,
    MIN(snapshot_ts) as first_snapshot,
    MAX(snapshot_ts) as last_snapshot
FROM derived.snapshot_features_v1
WHERE game_id IN ('401810277', '401810250')
GROUP BY game_id
ORDER BY game_id;
```

### Step 7: Time Alignment Analysis (CRITICAL)
```sql
-- Check game start, ESPN timestamps, and Kalshi timestamps
WITH game_info AS (
    SELECT 
        sg.event_id AS game_id,
        sg.event_date AS game_start
    FROM espn.scoreboard_games sg
    WHERE sg.event_id IN ('401810277', '401810250')
),
espn_time_range AS (
    SELECT 
        p.game_id,
        MIN(p.last_modified_utc) as espn_first_raw,
        MAX(p.last_modified_utc) as espn_last_raw,
        EXTRACT(EPOCH FROM (MAX(p.last_modified_utc) - MIN(p.last_modified_utc)))::INTEGER as espn_duration_seconds
    FROM espn.probabilities_raw_items p
    WHERE p.game_id IN ('401810277', '401810250')
    GROUP BY p.game_id
),
kalshi_time_range AS (
    SELECT 
        kmw.espn_event_id as game_id,
        MIN(kc.period_ts) as kalshi_first,
        MAX(kc.period_ts) as kalshi_last
    FROM kalshi.markets_with_games kmw
    JOIN kalshi.candlesticks kc ON kmw.ticker = kc.ticker
    WHERE kmw.espn_event_id IN ('401810277', '401810250')
      AND kc.yes_bid_close IS NOT NULL
      AND kc.yes_ask_close IS NOT NULL
    GROUP BY kmw.espn_event_id
),
aligned_espn_range AS (
    SELECT 
        etr.game_id,
        gi.game_start,
        etr.espn_first_raw,
        etr.espn_last_raw,
        etr.espn_duration_seconds,
        -- Calculate aligned timestamps
        gi.game_start + (etr.espn_first_raw - etr.espn_first_raw) as espn_first_aligned,  -- Should equal game_start
        gi.game_start + (etr.espn_last_raw - etr.espn_first_raw) as espn_last_aligned,
        -- Calculate Kalshi window
        gi.game_start as kalshi_window_start,
        gi.game_start + (etr.espn_duration_seconds || ' seconds')::INTERVAL as kalshi_window_end
    FROM espn_time_range etr
    JOIN game_info gi ON etr.game_id = gi.game_id
)
SELECT 
    aer.game_id,
    aer.game_start,
    aer.espn_first_raw,
    aer.espn_last_raw,
    aer.espn_first_aligned,
    aer.espn_last_aligned,
    aer.kalshi_window_start,
    aer.kalshi_window_end,
    ktr.kalshi_first,
    ktr.kalshi_last,
    CASE 
        WHEN ktr.kalshi_first IS NULL THEN 'NO_KALSHI_DATA'
        WHEN ktr.kalshi_first >= aer.kalshi_window_start 
         AND ktr.kalshi_last <= aer.kalshi_window_end THEN 'FULL_OVERLAP'
        WHEN ktr.kalshi_first <= aer.kalshi_window_end 
         AND ktr.kalshi_last >= aer.kalshi_window_start THEN 'PARTIAL_OVERLAP'
        ELSE 'NO_OVERLAP'
    END as overlap_status,
    CASE 
        WHEN ktr.kalshi_first IS NULL THEN NULL
        ELSE EXTRACT(EPOCH FROM (aer.kalshi_window_start - ktr.kalshi_last))
    END as gap_seconds_window_after_kalshi,
    CASE 
        WHEN ktr.kalshi_first IS NULL THEN NULL
        ELSE EXTRACT(EPOCH FROM (ktr.kalshi_first - aer.kalshi_window_end))
    END as gap_seconds_kalshi_after_window
FROM aligned_espn_range aer
LEFT JOIN kalshi_time_range ktr ON aer.game_id = ktr.game_id
ORDER BY aer.game_id;
```

### Step 8: Sample Alignment Check
```sql
-- Check actual alignment in materialized view for one game
SELECT 
    sequence_number,
    snapshot_ts as aligned_ts,
    espn_home_prob,
    kalshi_home_mid_price,
    CASE 
        WHEN kalshi_home_mid_price IS NOT NULL THEN 'ALIGNED'
        ELSE 'NO_KALSHI'
    END as alignment_status
FROM derived.snapshot_features_v1
WHERE game_id = '401810277'
ORDER BY sequence_number
LIMIT 20;
```

### Step 9: Check Raw ESPN Timestamps vs Aligned
```sql
-- Verify alignment is working correctly
SELECT 
    sfv.sequence_number,
    sfv.snapshot_ts as aligned_ts,
    p.last_modified_utc as raw_espn_ts,
    sg.event_date as game_start,
    EXTRACT(EPOCH FROM (sfv.snapshot_ts - sg.event_date)) as elapsed_from_game_start,
    EXTRACT(EPOCH FROM (p.last_modified_utc - MIN(p.last_modified_utc) OVER (PARTITION BY p.game_id))) as elapsed_from_first_raw
FROM derived.snapshot_features_v1 sfv
JOIN espn.probabilities_raw_items p 
    ON sfv.game_id = p.game_id 
    AND sfv.sequence_number = p.sequence_number
JOIN espn.scoreboard_games sg ON sg.event_id = sfv.game_id
WHERE sfv.game_id IN ('401810277', '401810250')
ORDER BY sfv.game_id, sfv.sequence_number
LIMIT 20;
```

---

## Evidence to Capture

### Step 1 - Game Metadata:
```
‚úÖ Both games exist:
- 401810250: 2025-12-20 19:30:00-08, LAC vs LAL, status_completed=f
- 401810277: 2025-12-23 19:30:00-08, LAC vs HOU, status_completed=f
```

### Step 2 - Materialized View Coverage:
```
‚ùå CRITICAL: Both games have 0% alignment:
- 401810250: 473 snapshots, 0 with Kalshi data (0.00%)
- 401810277: 428 snapshots, 0 with Kalshi data (0.00%)

Aligned timestamps:
- 401810250: 19:30:00-08 to 22:15:00-08
- 401810277: 19:30:00-08 to 21:48:00-08
```

### Step 3 - Time Alignment Analysis:
```
üö® ROOT CAUSE IDENTIFIED:

Game 401810250:
- Game start: 2025-12-20 19:30:00-08
- ESPN first RAW: 2025-12-20 22:40:00-08 (3h 10m AFTER game start!)
- ESPN last RAW: 2025-12-21 01:25:00-08
- ESPN duration: ~2h 45m
- Kalshi window: 19:30:00-08 to 22:15:00-08 (2h 45m window)
- Kalshi data: 2025-12-19 16:00:00-08 to 2025-12-20 22:01:00-08
- Overlap status: PARTIAL_OVERLAP

Game 401810277:
- Game start: 2025-12-23 19:30:00-08
- ESPN first RAW: 2025-12-23 22:42:00-08 (3h 12m AFTER game start!)
- ESPN last RAW: 2025-12-24 01:00:00-08
- ESPN duration: ~2h 18m
- Kalshi window: 19:30:00-08 to 21:48:00-08 (2h 18m window)
- Kalshi data: 2025-12-22 16:00:00-08 to 2025-12-23 22:01:00-08
- Overlap status: PARTIAL_OVERLAP
```

### Step 4 - Sample Alignment Check:
```
‚ùå All 30 sample rows show NO_KALSHI status
- All aligned_ts values are at game start (19:30:00-08)
- All kalshi_home_mid_price are NULL
- ESPN probabilities are present (0.45-0.70 range)
```

### Step 5 - games_with_kalshi Filter Status:
```
‚úÖ Both games PASS the filter (HAS_KALSHI)
- Confirms games are included in materialized view
- But alignment still fails
```

---

## Hypotheses

Based on the investigation, likely causes:

1. **No Kalshi Markets**: Games don't have Kalshi markets mapped
2. **No Candlesticks**: Markets exist but no candlestick data with bid/ask
3. **Time Window Mismatch**: Even after alignment, Kalshi data doesn't overlap with ESPN window
4. **Alignment Bug**: Time alignment logic has an error
5. **Data Quality Issue**: Missing game_start or other required fields

---

## Next Steps

1. ‚è≥ Run investigation queries
2. ‚è≥ Document findings
3. ‚è≥ Identify root cause
4. ‚è≥ Fix if needed

